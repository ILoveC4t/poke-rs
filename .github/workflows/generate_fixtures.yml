name: Generate Test Fixtures

on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * 1'

jobs:
  generate-fixtures:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Fetch damage-calc
        run: |
          mkdir -p fixtures-temp
          git clone --depth 1 https://github.com/smogon/damage-calc.git fixtures-temp/damage-calc

      - name: Generate fixtures
        run: |
          cd fixtures-temp
          npm init -y
          npm pkg set type=module
          npm install tsx typescript
          DAMAGE_CALC_PATH="${{ github.workspace }}/fixtures-temp/damage-calc" \
            npx tsx "${{ github.workspace }}/scripts/generate_damage_calc_fixtures.mts"
          DAMAGE_CALC_PATH="${{ github.workspace }}/fixtures-temp/damage-calc" \
            npx tsx "${{ github.workspace }}/scripts/scrape_damage_tests.mts"

      - name: Cleanup
        run: |
          rm -rf fixtures-temp

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore(fixtures): refresh damage-calc fixtures"
          title: "Update Test Fixtures (damage-calc)"
          body: |
            This PR updates vendored JSON fixtures generated from smogon/damage-calc.

            **Generated Files:**
            - `tests/fixtures/damage-calc/stats.json` - Basic stat calculation test cases
            - `tests/fixtures/damage-calc/stats-full.json` - Complete stat tests (displayStat, calcStat, DV/IV, Gen 2 modifiers)
            - `tests/fixtures/damage-calc/damage.json` - Damage calculation test cases (scraped from calc.test.ts)
            - `tests/fixtures/damage-calc/pokemon.json` - Pokemon construction and forme tests

            *Auto-generated by GitHub Actions.*
          branch: fixtures-update
          delete-branch: true
