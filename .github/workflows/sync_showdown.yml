name: Sync Showdown Data

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 1'

jobs:
  update-data:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Fetch and Convert Data
        run: |
          mkdir -p extractor
          cd extractor
          
          npm init -y
          npm install typescript tsx @types/node

          git clone --depth 1 https://github.com/smogon/pokemon-showdown.git showdown

          # This script imports the data structures natively and saves them as JSON
          echo "
          // Import data directly from the cloned source
          // Note: We use the standardized export names found in modern Showdown files
          import { Pokedex } from './showdown/data/pokedex';
          import { Moves } from './showdown/data/moves';
          import { TypeChart } from './showdown/data/typechart';
          import { Items } from './showdown/data/items';
          import { Abilities } from './showdown/data/abilities';
          import { Natures } from './showdown/data/natures';
          import { Learnsets } from './showdown/data/learnsets';

          import * as fs from 'fs';
          import * as path from 'path';

          // Define output directory (repo_root/data)
          const OUTPUT_DIR = path.resolve('..', 'data');

          // Helper function to safely write JSON files
          const save = (name: string, data: any) => {
              if (data === undefined) {
                  console.error(\`Error: Data for '\${name}' is undefined. The export name might have changed.\`);
                  process.exit(1);
              }
              
              const filePath = path.join(OUTPUT_DIR, name + '.json');
              
              // Write minified JSON (remove null, 2 for pretty print if preferred)
              fs.writeFileSync(filePath, JSON.stringify(data, null, 2));
              console.log(\`Saved: \${filePath}\`);
          };

          // Main Execution
          if (!fs.existsSync(OUTPUT_DIR)) {
              fs.mkdirSync(OUTPUT_DIR, { recursive: true });
          }

          console.log('Starting data extraction...');
          save('pokedex', Pokedex);
          save('moves', Moves);
          save('typechart', TypeChart);
          save('items', Items);
          save('abilities', Abilities);
          save('natures', Natures);
          save('learnsets', Learnsets);
          console.log('Extraction complete.');
          " > extract.ts

          npx tsx extract.ts

          # Cleanup
          cd ..
          rm -rf extractor

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore(data): sync with smogon/pokemon-showdown"
          title: "Update Battle Data (Showdown Sync)"
          body: |
            This PR updates the JSON data sources from the latest [smogon/pokemon-showdown](https://github.com/smogon/pokemon-showdown) repository.

            **Updated Files:**
            - `pokedex.json` (Species stats & types)
            - `moves.json` (Base power, accuracy, flags)
            - `typechart.json` (Weakness/Resistance matrix)
            - `items.json` (Held item metadata)
            - `abilities.json` (Ability metadata)
            - `natures.json` (Stat modifiers)
            - `learnsets.json` (Legal move pools)

            *Auto-generated by GitHub Actions via `tsx` extraction.*
          branch: data-sync-update
          delete-branch: true
